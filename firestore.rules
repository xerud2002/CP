rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user is admin
    function isAdmin() {
      return isAuthenticated() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Users collection - base profiles with role
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow update: if isAuthenticated() && (request.auth.uid == userId || isAdmin());
      allow delete: if isAdmin(); // Only admin can delete users
    }
    
    // Extended courier profiles
    match /profil_curier/{userId} {
      allow read: if isAuthenticated(); // Public read (clients need to see)
      allow write: if isAuthenticated() && (userId == request.auth.uid || isAdmin());
      // Allow updates to rating and reviewCount from any authenticated user (for review system)
      allow update: if isAuthenticated() && 
        (userId == request.auth.uid || 
         isAdmin() ||
         // Allow updating only rating and reviewCount fields
         (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['rating', 'reviewCount'])));
    }
    
    // Extended client profiles
    match /profil_client/{userId} {
      allow read: if isAuthenticated() && (userId == request.auth.uid || isAdmin());
      allow write: if isAuthenticated() && (userId == request.auth.uid || isAdmin());
    }
    
    // Courier coverage zones
    match /zona_acoperire/{docId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.resource.data.uid == request.auth.uid;
      allow update, delete: if isAuthenticated() && (resource.data.uid == request.auth.uid || isAdmin());
    }
    
    // Courier pricing
    match /tarife_curier/{docId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.resource.data.uid == request.auth.uid;
      allow update, delete: if isAuthenticated() && (resource.data.uid == request.auth.uid || isAdmin());
    }
    
    // Person transport routes
    match /transport_persoane/{docId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.resource.data.uid == request.auth.uid;
      allow update, delete: if isAuthenticated() && (resource.data.uid == request.auth.uid || isAdmin());
    }
    
    // Orders - simplified without status checks
    match /comenzi/{docId} {
      // Clients read own orders, couriers read all orders, admin reads everything
      allow read: if isAuthenticated() && 
        (resource.data.uid_client == request.auth.uid || 
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'curier' ||
         isAdmin());
      // Clients create orders
      allow create: if isAuthenticated() && 
        request.resource.data.uid_client == request.auth.uid;
      // Clients, couriers, and admin can update
      allow update: if isAuthenticated() && 
        (resource.data.uid_client == request.auth.uid || 
         resource.data.courierId == request.auth.uid ||
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'curier' ||
         isAdmin());
      // Clients can delete own orders, admin can delete any order
      allow delete: if isAuthenticated() && 
        (resource.data.uid_client == request.auth.uid || isAdmin());
    }
    
    // Reviews
    match /recenzii/{docId} {
      allow read: if isAuthenticated(); // Public read
      allow create: if isAuthenticated() && 
        request.resource.data.clientId == request.auth.uid;
      allow update, delete: if isAuthenticated() && 
        (resource.data.clientId == request.auth.uid || isAdmin());
    }
    
    // Order number counter
    match /counters/{counterId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated(); // Needed for transactions
    }
    
    // Messages - chat between client and couriers for orders
    match /mesaje/{messageId} {
      // Read: client who owns order OR courier assigned to order OR any courier (to see all opportunities)
      allow read: if isAuthenticated();
      
      // Create: authenticated users (client or courier)
      allow create: if isAuthenticated() && 
        request.resource.data.senderId == request.auth.uid;
      
      // Update: message sender, receiver (for marking as read), or admin
      allow update: if isAuthenticated() && 
        (resource.data.senderId == request.auth.uid || 
         resource.data.receiverId == request.auth.uid ||
         resource.data.clientId == request.auth.uid ||
         resource.data.courierId == request.auth.uid ||
         isAdmin());
      
      // Delete: only message sender or admin
      allow delete: if isAuthenticated() && 
        (resource.data.senderId == request.auth.uid || isAdmin());
    }
    
    // Admin messages collection - for direct admin-to-user messaging
    match /admin_messages/{messageId} {
      // Read: admin OR user who is in participants array
      allow read: if isAuthenticated() && 
        (isAdmin() || request.auth.uid in resource.data.participants);
      
      // Create: admin OR the sender must be the authenticated user
      allow create: if isAuthenticated() && 
        (isAdmin() || request.auth.uid == request.resource.data.senderId) &&
        request.resource.data.senderId in request.resource.data.participants &&
        request.resource.data.receiverId in request.resource.data.participants;
      
      // Update: admin OR participants (for marking as read)
      allow update: if isAuthenticated() && 
        (isAdmin() || request.auth.uid in resource.data.participants);
      
      // Delete: only admin
      allow delete: if isAdmin();
    }
  }
}
